sudo: required

language: generic

services:
  - docker

install:
  - sudo cp ./bin/fin /usr/local/bin/fin
  - fin version
  - USE_BRANCH="${TRAVIS_BRANCH}"
  - if [[ "$TRAVIS_PULL_REQUEST" != "false" && "${TRAVIS_PULL_REQUEST_SLUG}" == "${TRAVIS_REPO_SLUG}" ]]; then USE_BRANCH="${TRAVIS_PULL_REQUEST_BRANCH}"; fi
  - if [[ "$TRAVIS_PULL_REQUEST" != "false" && "${TRAVIS_PULL_REQUEST_SLUG}" != "${TRAVIS_REPO_SLUG}" ]]; then USE_BRANCH='develop'; fi
  - export DOCKSAL_VERSION=${USE_BRANCH}
  - fin update
  - fin sysinfo

before_script:
  - git clone https://github.com/docksal/drupal8.git ../drupal8
  - mkdir ../test-config
  - mkdir ../test-duplicates

script:
  # Checks whether its a quick test
  - is_not_quicktest() { [[ ! "$TRAVIS_COMMIT_MESSAGE" =~ "[quick-test]" ]]; }
  # Runs tests by file name
  - run_tests() { bats "$TRAVIS_BUILD_DIR/tests/$1"; }
  # Testing Docksal system services
  - if is_not_quicktest; then run_tests system.bats; fi
  # Test Docksal configuration system
  - if is_not_quicktest; then cd "$TRAVIS_BUILD_DIR/../test-config"; run_tests config.bats; fi
  # Test a project workflow
  - if is_not_quicktest; then cd "$TRAVIS_BUILD_DIR/../drupal8"; run_tests general.bats; fi
  # Test duplicates detection
  - if is_not_quicktest; then cd "$TRAVIS_BUILD_DIR/../test-duplicates"; run_tests duplicates.bats; fi
  # Quick tests
  - if ! is_not_quicktest; then run_tests quicktest.bats; fi

after_success:
  - cd "$TRAVIS_BUILD_DIR"
  # Trigger builds in example project repos
  - |
    if [[ "$TRAVIS_BRANCH" == "master" ]]; then \
      tests/scripts/travisci-build-trigger docksal/drupal7 \
      tests/scripts/travisci-build-trigger docksal/drupal7-advanced \
      tests/scripts/travisci-build-trigger docksal/drupal8 \
      tests/scripts/travisci-build-trigger docksal/wordpress \
      tests/scripts/travisci-build-trigger docksal/magento \
      tests/scripts/travisci-build-trigger docksal/magento-demo \
    fi
